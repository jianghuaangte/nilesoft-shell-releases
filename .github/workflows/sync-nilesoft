name: Auto Update Nilesoft Shell

on:
  schedule:
    # 每天北京时间00:00运行 (UTC时间16:00)
    - cron: '0 16 * * *'
  workflow_dispatch: # 允许手动触发

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Get latest version
      id: get_version
      run: |
        VERSION=$(curl -s https://nilesoft.org/download | grep -oP 'Shell version \K[0-9]+\.[0-9]+\.[0-9]+')
        echo "Latest version: $VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        
    - name: Download files
      run: |
        VERSION="${{ steps.get_version.outputs.version }}"
        echo "Downloading version: $VERSION"
        
        # 创建下载目录
        mkdir -p downloads
        
        # 下载所有文件
        curl -L -o "downloads/setup-x64.msi" "https://nilesoft.org/download/shell/$VERSION/setup-x64.msi"
        curl -L -o "downloads/setup-x86.msi" "https://nilesoft.org/download/shell/$VERSION/setup-x86.msi"
        curl -L -o "downloads/setup-arm64.msi" "https://nilesoft.org/download/shell/$VERSION/setup-arm64.msi"
        curl -L -o "downloads/portable.zip" "https://nilesoft.org/download/shell/$VERSION/portable.zip"
        
        # 检查文件是否下载成功
        ls -la downloads/
        
    - name: Create tag and release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.get_version.outputs.version }}
        name: Nilesoft Shell v${{ steps.get_version.outputs.version }}
        body: |
          Automated release of Nilesoft Shell version ${{ steps.get_version.outputs.version }}
          
          **Download links:**
          - setup-x64.msi (64-bit installer)
          - setup-x86.msi (32-bit installer) 
          - setup-arm64.msi (ARM64 installer)
          - portable.zip (Portable version)
          
          **Release Date:** ${{ github.event.head_commit.timestamp }}
        files: |
          downloads/setup-x64.msi
          downloads/setup-x86.msi
          downloads/setup-arm64.msi
          downloads/portable.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
